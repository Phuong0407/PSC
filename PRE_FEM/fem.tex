\documentclass{book}

\usepackage{amsmath}
\usepackage{esdiff}
\usepackage[paper=a3paper, inner = 2cm, outer = 2cm, top = 2cm, bottom = 2cm]{geometry}

\begin{document}

Weak form of Laplace equation:
\begin{align}
    \Delta u(x,y) = 0.
\end{align}

\begin{align*}
    \forall w, \quad 0 = \int_{\Omega} w(\Delta u) d\Omega = \int_{\Omega} w [\underline{\nabla} \cdot (\underline{\nabla} u)] d\Omega = \int_{\partial\Omega} w \underline{\nabla} u \cdot \underline{n} dS - \int_{\Omega} \underline{\nabla}w \cdot \underline{\nabla}u d\Omega
\end{align*}


\begin{align*}
    \forall w, \quad \int_{\Omega} \underline{\nabla}w \cdot \underline{\nabla}u d\Omega = \int_{\partial\Omega} w \underline{\nabla} u \cdot \underline{n} dS
\end{align*}


We approximate the solution by
\begin{align*}
    & u(x, y) = \sum_{i = 0}^m N_i(x, y) u_i \\
    & w(x, y) = \sum_{i = 0}^m N_i(x, y) w_i \\
\end{align*}

\begin{align*}
    \underline{\nabla} u(x, y) = \begin{bmatrix}
        \diffp{u}{x} \\
        \diffp{u}{y} \\
        \end{bmatrix}
        = 
        \begin{bmatrix}
            \diffp{N_1}{x}u_1 + \dots + \diffp{N_m}{x}u_m \\
            \diffp{N_1}{y}u_1 + \dots + \diffp{N_m}{y}u_m \\
        \end{bmatrix}
        =
        \begin{bmatrix}
            \diffp{N_1}{x} & \dots & \diffp{N_m}{x} \\
            \diffp{N_1}{y} & \dots & \diffp{N_m}{y} 
        \end{bmatrix} \cdot \begin{bmatrix}
            u_1 \\
            \vdots \\
            u_m 
        \end{bmatrix}
\end{align*}


\begin{align*}
    \underline{\nabla} w(x, y) = \begin{bmatrix}
        \diffp{w}{x} \\
        \diffp{w}{y} \\
        \end{bmatrix}
        = 
        \begin{bmatrix}
            \diffp{N_1}{x}w_1 + \dots + \diffp{N_m}{x}w_m \\
            \diffp{N_1}{y}w_1 + \dots + \diffp{N_m}{y}w_m \\
        \end{bmatrix}
        =
        \begin{bmatrix}
            \diffp{N_1}{x} & \dots & \diffp{N_m}{x} \\
            \diffp{N_1}{y} & \dots & \diffp{N_m}{y} 
        \end{bmatrix} \cdot \begin{bmatrix}
            w_1 \\
            \vdots \\
            w_m 
        \end{bmatrix}
\end{align*}

\begin{align*}
    \underline{\nabla}w \cdot \underline{\nabla}u
    =
    \begin{bmatrix}
        w_1 & \dots & w_m
    \end{bmatrix}
    \begin{bmatrix}
        \diffp{N_1}{x} & \diffp{N_1}{y} \\
        \vdots & \vdots \\
        \diffp{N_m}{x} & \diffp{N_m}{y} 
    \end{bmatrix}
    \begin{bmatrix}
        \diffp{N_1}{x} & \dots & \diffp{N_m}{x} \\
        \diffp{N_1}{y} & \dots & \diffp{N_m}{y} 
    \end{bmatrix}
    \begin{bmatrix}
        u_1 \\
        \vdots \\
        u_m 
    \end{bmatrix}
    = [w] B^T B [u]
\end{align*}

\begin{align*}
    \boxed{\int_{\Omega} [w] B^T B [u] d\Omega = \int_{\partial\Omega} w \underline{\nabla} u \cdot \underline{n} dS}.
\end{align*}

For a local element:
\begin{align*}
    & 1 = (x_1, y_1) \\
    & 2 = (x_2, y_2) \\
    & 3 = (x_3, y_3) \\
    & 4 = (x_4, y_4) \\
\end{align*}

\begin{align*}
    J^{(1)}
    = \dfrac{1}{4}
    \begin{bmatrix}
        \eta - 1 & 1 - \eta & 1 + \eta & - \eta - 1 \\
        \xi - 1 & - \xi - 1 & 1 + \xi & 1 - \xi
    \end{bmatrix}
    \begin{bmatrix}
        x_1 & y_1 \\
        x_2 & y_2 \\
        x_3 & y_3 \\
        x_4 & y_4
    \end{bmatrix}
    = \dfrac{1}{4}
    \begin{bmatrix}
        (\eta - 1) (x_1 - x_2) + (1 + \eta) (x_3 - x_4) & (\eta - 1) (y_1 - y_2) + (1 + \eta) (y_3 - y_4) \\
        (\xi - 1) (x_1 - x_4) + (1 + \xi)(x_3 - x_2) & (\xi - 1) (y_1 - y_4) + (1 + \xi)(y_3 - y_2)
    \end{bmatrix}
\end{align*}

\begin{align*}
    \det(J^{(1)}) & = \dfrac{1}{16} \left[ (\eta - 1) (x_1 - x_2) + (1 + \eta) (x_3 - x_4) \right] \left[ (\xi - 1) (y_1 - y_4) + (1 + \xi)(y_3 - y_2) \right] - \dfrac{1}{16} \left[ (\eta - 1) (y_1 - y_2) + (1 + \eta) (y_3 - y_4) \right]\left[ (\xi - 1) (x_1 - x_4) + (1 + \xi)(x_3 - x_2) \right] \\
    % & = \dfrac{1}{16} \left[
    %     (\eta - 1)(x_1 - x_2 - y_1 + y_2) + 
    % \right]
\end{align*}

\begin{align*}
    (J^{(1)})^{-1} = \dfrac{1}{\det(J^{(1)})}
    \begin{bmatrix}
        (\xi - 1) (y_1 - y_4) + (1 + \xi)(y_3 - y_2) & -(\xi - 1) (x_1 - x_4) - (1 + \xi)(x_3 - x_2) \\
        -(\eta - 1) (y_1 - y_2) - (1 + \eta) (y_3 - y_4) & (\eta - 1) (x_1 - x_2) + (1 + \eta) (x_3 - x_4)
    \end{bmatrix}
\end{align*}

\begin{align*}
    B^{(1)} = \dfrac{1}{4} (J^{(1)})^{-1} \begin{bmatrix}
        \eta - 1 & 1 - \eta & 1 + \eta & - \eta - 1 \\
        \xi - 1 & - \xi - 1 & 1 + \xi & 1 - \xi
    \end{bmatrix}
\end{align*}

\begin{align*}
    & K^{(e)}_{11} = \left| J^{(1)} \left(-\dfrac{1}{\sqrt{3}}, -\dfrac{1}{\sqrt{3}}\right)\right| (B^{(1)})^T\left(-\dfrac{1}{\sqrt{3}}, -\dfrac{1}{\sqrt{3}}\right) B^{(1)}\left(-\dfrac{1}{\sqrt{3}}, -\dfrac{1}{\sqrt{3}}\right) \\
    & K^{(e)}_{12} = \left| J^{(1)} \left(-\dfrac{1}{\sqrt{3}}, \dfrac{1}{\sqrt{3}}\right)\right| (B^{(1)})^T\left(-\dfrac{1}{\sqrt{3}}, \dfrac{1}{\sqrt{3}}\right) B^{(1)}\left(-\dfrac{1}{\sqrt{3}}, \dfrac{1}{\sqrt{3}}\right) \\
    & K^{(e)}_{21} = \left| J^{(1)} \left(\dfrac{1}{\sqrt{3}}, -\dfrac{1}{\sqrt{3}}\right)\right| (B^{(1)})^T\left(\dfrac{1}{\sqrt{3}}, -\dfrac{1}{\sqrt{3}}\right) B^{(1)}\left(\dfrac{1}{\sqrt{3}}, -\dfrac{1}{\sqrt{3}}\right) \\
    & K^{(e)}_{22} = \left| J^{(1)} \left(\dfrac{1}{\sqrt{3}}, \dfrac{1}{\sqrt{3}}\right)\right| (B^{(1)})^T\left(\dfrac{1}{\sqrt{3}}, \dfrac{1}{\sqrt{3}}\right) B^{(1)}\left(\dfrac{1}{\sqrt{3}}, \dfrac{1}{\sqrt{3}}\right)
\end{align*}



For a rectangular element,
\begin{align*}
\begin{bmatrix}
    \dfrac{1}{3} \left(\dfrac{x}{y} + \dfrac{y}{x}\right) & \dfrac{1}{6} \left(\dfrac{x}{y} - 2\dfrac{y}{x}\right) & -\dfrac{1}{6} \left(\dfrac{x}{y} + \dfrac{y}{x}\right) & \dfrac{1}{6} \left(\dfrac{y}{x} - 2\dfrac{x}{y}\right) \\
    \dfrac{1}{6} \left(\dfrac{x}{y} - 2\dfrac{y}{x}\right)  & \dfrac{1}{3} \left(\dfrac{x}{y} + \dfrac{y}{x}\right) & \dfrac{1}{6} \left(\dfrac{y}{x} - 2\dfrac{x}{y}\right) & -\dfrac{1}{6} \left(\dfrac{x}{y} + \dfrac{y}{x}\right) \\
    -\dfrac{1}{6} \left(\dfrac{x}{y} + \dfrac{y}{x}\right) & \dfrac{1}{6} \left(\dfrac{y}{x} - 2\dfrac{x}{y}\right) & \dfrac{1}{3} \left(\dfrac{x}{y} + \dfrac{y}{x}\right) & \dfrac{1}{6} \left(\dfrac{x}{y} - 2\dfrac{y}{x}\right)  \\
    \dfrac{1}{6} \left(\dfrac{y}{x} - 2\dfrac{x}{y}\right) & -\dfrac{1}{6} \left(\dfrac{x}{y} + \dfrac{y}{x}\right) & \dfrac{1}{6} \left(\dfrac{x}{y} - 2\dfrac{y}{x}\right) & \dfrac{1}{3} \left(\dfrac{x}{y} + \dfrac{y}{x}\right) \\
\end{bmatrix}
\end{align*}


We need to assembly the matrix, where the numbering is 0 - 1 - 2 - 3, counterclockwise for each element. The local stiffness matrices are:
\[
K^{(1)} = 
\begin{bmatrix}
K^{(1)}_{00} & K^{(1)}_{01} & K^{(1)}_{02} & K^{(1)}_{03} \\
K^{(1)}_{10} & K^{(1)}_{11} & K^{(1)}_{12} & K^{(1)}_{13} \\
K^{(1)}_{20} & K^{(1)}_{21} & K^{(1)}_{22} & K^{(1)}_{23} \\
K^{(1)}_{30} & K^{(1)}_{31} & K^{(1)}_{32} & K^{(1)}_{33}
\end{bmatrix},
\quad
K^{(2)} = 
\begin{bmatrix}
K^{(2)}_{00} & K^{(2)}_{01} & K^{(2)}_{02} & K^{(2)}_{03} \\
K^{(2)}_{10} & K^{(2)}_{11} & K^{(2)}_{12} & K^{(2)}_{13} \\
K^{(2)}_{20} & K^{(2)}_{21} & K^{(2)}_{22} & K^{(2)}_{23} \\
K^{(2)}_{30} & K^{(2)}_{31} & K^{(2)}_{32} & K^{(2)}_{33}
\end{bmatrix}.
\]

The global stiffness matrix $K_{\text{global}}$ starts as a zero matrix:
\[
K_{\text{global}} = 
\begin{bmatrix}
0 & 0 & 0 & 0 & 0 & 0 \\
0 & 0 & 0 & 0 & 0 & 0 \\
0 & 0 & 0 & 0 & 0 & 0 \\
0 & 0 & 0 & 0 & 0 & 0 \\
0 & 0 & 0 & 0 & 0 & 0 \\
0 & 0 & 0 & 0 & 0 & 0
\end{bmatrix}.
\]

Adding $K^{(1)}$: Mapping $\{0, 1, 2, 3\}$ to $\{0, 1, 2, 3\}$:
$K_{\text{global}}[i, j] = K^{(1)}[i, j] \quad \forall i, j \in \{0, 1, 2, 3\}$.

After this step:
\[
K_{\text{global}} =
    \begin{bmatrix}
        K^{(1)}_{00} & K^{(1)}_{01} & K^{(1)}_{02} & K^{(1)}_{03} & 0 & 0 \\
        K^{(1)}_{10} & K^{(1)}_{11} & K^{(1)}_{12} & K^{(1)}_{13} & 0 & 0 \\
        K^{(1)}_{20} & K^{(1)}_{21} & K^{(1)}_{22} & K^{(1)}_{23} & 0 & 0 \\
        K^{(1)}_{30} & K^{(1)}_{31} & K^{(1)}_{32} & K^{(1)}_{33} & 0 & 0 \\
        0 & 0 & 0 & 0 & 0 & 0 \\
        0 & 0 & 0 & 0 & 0 & 0
    \end{bmatrix}.
\]

Then adding $K^{(2)}$: mapping $\{0, 1, 2, 3\}$ to $\{1, 4, 5, 3\}$: $K_{\text{global}}[g_i, g_j] += K^{(2)}[i, j] \quad \forall i, j \in \{0, 1, 2, 3\}$, where $g_i = M^{(2)}[i]$ and $g_j = M^{(2)}[j]$.

After this step:
\[
    K_{\text{global}} =
    \begin{bmatrix}
        K^{(1)}_{00} & K^{(1)}_{01} & K^{(1)}_{02} & K^{(1)}_{03} & 0 & 0 \\
        K^{(1)}_{10} & K^{(1)}_{11} + K^{(2)}_{00} & K^{(1)}_{12} & K^{(1)}_{13} + K^{(2)}_{03} & K^{(2)}_{01} & K^{(2)}_{02} \\
        K^{(1)}_{20} & K^{(1)}_{21} & K^{(1)}_{22} & K^{(1)}_{23} & 0 & 0 \\
        K^{(1)}_{30} & K^{(1)}_{31} + K^{(2)}_{30} & K^{(1)}_{32} & K^{(1)}_{33} + K^{(2)}_{33} & K^{(2)}_{31} & K^{(2)}_{32} \\
        0 & K^{(2)}_{10} & 0 & K^{(2)}_{13} & K^{(2)}_{11} & K^{(2)}_{12} \\
        0 & K^{(2)}_{20} & 0 & K^{(2)}_{23} & K^{(2)}_{21} & K^{(2)}_{22}
    \end{bmatrix}.
\]

Final Global Stiffness Matrix: The final $K_{\text{global}}$ combines contributions from all elements:
\[
    K_{\text{global}} = \sum_{e=1}^{E} \text{Assemble}\left(K^{(e)}\right).
\]

The example result:
\[
\begin{bmatrix}
K^{(1)}_{00} & K^{(1)}_{01} & 0 & K^{(1)}_{03} & K^{(1)}_{02} & 0 & 0 & 0 & 0 \\
K^{(1)}_{10} & K^{(1)}_{11} + K^{(2)}_{00} & K^{(2)}_{01} & K^{(1)}_{13} & K^{(1)}_{12} + K^{(2)}_{03} & K^{(2)}_{02} & 0 & 0 & 0 \\
0 & K^{(2)}_{10} & K^{(2)}_{11} & 0 & K^{(2)}_{13} & K^{(2)}_{12} & 0 & 0 & 0 \\
K^{(1)}_{30} & K^{(1)}_{31} & 0 & K^{(1)}_{33} + K^{(4)}_{00} & K^{(1)}_{32} + K^{(4)}_{01} & 0 & K^{(4)}_{03} & K^{(4)}_{02} & 0 \\
K^{(1)}_{20} & K^{(1)}_{21} + K^{(2)}_{30} & K^{(2)}_{31} & K^{(1)}_{23} + K^{(4)}_{10} & K^{(1)}_{22} + K^{(2)}_{33} + K^{(3)}_{00} + K^{(4)}_{11} & K^{(2)}_{32} + K^{(3)}_{01} & K^{(4)}_{13} & K^{(3)}_{03} + K^{(4)}_{12} & K^{(3)}_{02} \\
0 & K^{(2)}_{20} & K^{(2)}_{21} & 0 & K^{(2)}_{23} + K^{(3)}_{10} & K^{(2)}_{22} + K^{(3)}_{11} & 0 & K^{(3)}_{13} & K^{(3)}_{12} \\
0 & 0 & 0 & K^{(4)}_{30} & K^{(4)}_{31} & 0 & K^{(4)}_{33} & K^{(4)}_{32} & 0 \\
0 & 0 & 0 & K^{(4)}_{20} & K^{(3)}_{30} + K^{(4)}_{21} & K^{(3)}_{31} & K^{(4)}_{23} & K^{(3)}_{33} + K^{(4)}_{22} & K^{(3)}_{32} \\
0 & 0 & 0 & 0 & K^{(3)}_{20} & K^{(3)}_{21} & 0 & K^{(3)}_{23} & K^{(3)}_{22}
\end{bmatrix}
\]



\begin{align*}
    \forall w, \quad \int_{\Omega} \underline{\nabla}w \cdot \underline{\nabla}u d\Omega = \int_{\partial\Omega} w \underline{\nabla} u \cdot \underline{n} dS = \int_{\partial\Omega} w(x_\ell, y) g(x, y) dS = \int_{\Gamma_{left}} - w(x_\ell, y) g(x_\ell, y) dy + \int_{\Gamma_{right}} w(x_r, y) g(x_r, y) dy
\end{align*}

% For the right-hand side:
% \begin{align*}
%     \underline{\nabla} u(x, y) = \begin{bmatrix}
%         \diffp{u}{x} \\
%         \diffp{u}{y} \\
%         \end{bmatrix}
%         = 
%         \begin{bmatrix}
%             \diffp{N_1}{x}u_1 + \dots + \diffp{N_m}{x}u_m \\
%             \diffp{N_1}{y}u_1 + \dots + \diffp{N_m}{y}u_m \\
%         \end{bmatrix}
%         =
%         \begin{bmatrix}
%             \diffp{N_1}{x} & \dots & \diffp{N_m}{x} \\
%             \diffp{N_1}{y} & \dots & \diffp{N_m}{y} 
%         \end{bmatrix} \cdot \begin{bmatrix}
%             u_1 \\
%             \vdots \\
%             u_m 
%         \end{bmatrix}
% \end{align*}


% \begin{align*}
%     w\underline{\nabla}u = \left( \sum_{i = 0}^m N_i(x, y) w_i \right) 
%     \begin{bmatrix}
%         \diffp{N_1}{x}u_1 + \dots + \diffp{N_m}{x}u_m \\
%         \diffp{N_1}{y}u_1 + \dots + \diffp{N_m}{y}u_m \\
%     \end{bmatrix}
%     =
%     \begin{bmatrix}
%         \diffp{N_1}{x}u_1 + \dots + \diffp{N_m}{x}u_m \\
%         \diffp{N_1}{y}u_1 + \dots + \diffp{N_m}{y}u_m \\
%     \end{bmatrix}
%     =
%     \sum_{i = 1}^{m} w_i N_i(x, y)\left[ \sum_{j = 1}^{m} u_j \left(n_1(x, y)\diffp{N_j}{x}(x,y) + n_2(x, y)\diffp{N_j}{y}(x,y)\right)\right]
% \end{align*}


% \begin{align*}
%     w\underline{\nabla}u = \sum_{i = 1}^{m} \sum_{j = 1}^{m} w_i u_j \left[ \left(n_1(x, y)\diffp{N_j}{x}(x,y)N_i(x, y) + n_2(x, y)\diffp{N_j}{y}(x,y)N_i(x, y)\right)\right]
% \end{align*}

% Then
% \begin{align*}
%     \int_{\partial\Omega} w \underline{\nabla} u \cdot \underline{n} dS = \sum_{i = 1}^{m} \sum_{j = 1}^{m} w_i u_j \int_{\partial\Omega} \left[ \left(n_1(x, y)\diffp{N_j}{x}(x,y)N_i(x, y) + n_2(x, y)\diffp{N_j}{y}(x,y)N_i(x, y)\right)\right] dS.
% \end{align*}

% \begin{align*}
%     \int_{\Gamma_{left}} w \underline{\nabla} u \cdot \underline{n} dS = \sum_{i = 1}^{m} \sum_{j = 1}^{m} w_i u_j \int_{\Gamma_{left}} \left(-\diffp{N_j}{x}(x,y)N_i(x, y)\right) dS.
% \end{align*}

% \begin{align*}
%     \int_{\Gamma_{right}} w \underline{\nabla} u \cdot \underline{n} dS = \sum_{i = 1}^{m} \sum_{j = 1}^{m} w_i u_j \int_{\Gamma_{right}} \left(\diffp{N_j}{x}(x,y)N_i(x, y)\right) dS.
% \end{align*}

% \begin{align*}
%     \begin{bmatrix}
%         \diffp{N_i^e}{x} \\
%         \diffp{N_i^e}{y}
%     \end{bmatrix}
%     =
%     \begin{bmatrix}
%         \diffp{N_1^e}{x} & \ldots & \diffp{N_m^e}{x} \\
%         \diffp{N_1^e}{y} & \ldots & \diffp{N_m^e}{y} 
%     \end{bmatrix}
%     =
%     J^{-1}
%     \begin{bmatrix}
%         \diffp{N_i^e}{\xi} \\
%         \diffp{N_i^e}{\eta}
%     \end{bmatrix}
%     =
%     J^{-1}
%     \begin{bmatrix}
%         \diffp{N_1}{\xi} & \dots & \diffp{N_m}{\xi} \\
%         \diffp{N_1}{\eta} & \dots & \diffp{N_m}{\eta} 
%     \end{bmatrix}
% \end{align*}

% with the notation of the first row: $J^{-1}_{11}$ and $J^{-1}_{12}$, we have:

% \begin{align*}
%     \begin{bmatrix}
%         \diffp{N_1^e}{x} & \ldots & \diffp{N_m^e}{x}
%     \end{bmatrix}
%     =
%     \begin{bmatrix}
%         J^{-1}_{11} & J^{-1}_{12}
%     \end{bmatrix}
%     \begin{bmatrix}
%         \diffp{N_1}{\xi} & \dots & \diffp{N_m}{\xi} \\
%         \diffp{N_1}{\eta} & \dots & \diffp{N_m}{\eta} 
%     \end{bmatrix}
% \end{align*}

For the right-hand side, we approximate the solution by
\begin{align*}
    & g(x, y) = \sum_{i = 0}^m N_i(x, y) g_i \\
    & w(x, y) = \sum_{i = 0}^m N_i(x, y) w_i \\
\end{align*}

\begin{align*}
    w(x, y) g(x, y) = \sum_{i = 0}^m \sum_{j = 0}^m N_i(x, y) N_j(x, y) w_i g_j.
\end{align*}

\begin{align*}
    \int_{\Gamma_{left}} - w(x_\ell, y) g(x_\ell, y) dy = \int_{y = 0}^{y = L_1} - w(x_\ell, y) g(x_\ell, y) dy = -\sum_{i = 0}^m \sum_{j = 0}^m w_i g_j \int_{y = 0}^{y = L_1} N_i(x_\ell, y) N_j(x_\ell, y) dy.
\end{align*}

With
\begin{align*}
    N_i(\xi, \eta)
    =
    \begin{bmatrix}
        \dfrac{1}{4}(1-\xi)(1-\eta) & \dfrac{1}{4}(1+\xi)(1-\eta) & \dfrac{1}{4}(1-\xi)(1+\eta) & \dfrac{1}{4}(1+\xi)(1+\eta)
    \end{bmatrix}
\end{align*}

\begin{align*}
    N_i(\xi, \eta)N_j(\xi, \eta)
    & =
    \begin{bmatrix}
        \dfrac{1}{4}(1-\xi)(1-\eta) \\
        \dfrac{1}{4}(1+\xi)(1-\eta) \\
        \dfrac{1}{4}(1-\xi)(1+\eta) \\
        \dfrac{1}{4}(1+\xi)(1+\eta)
    \end{bmatrix}
    \begin{bmatrix}
        \dfrac{1}{4}(1-\xi)(1-\eta) & \dfrac{1}{4}(1+\xi)(1-\eta) & \dfrac{1}{4}(1-\xi)(1+\eta) & \dfrac{1}{4}(1+\xi)(1+\eta)
    \end{bmatrix}\\
    & =
    \begin{bmatrix}
        \dfrac{1}{16}(1-\xi)^2(1-\eta)^2 & \dfrac{1}{16}(1-\xi^2)(1-\eta)^2 & \dfrac{1}{16}(1-\xi)^2(1-\eta^2) & \dfrac{1}{16}(1-\xi^2)(1-\eta^2) \\
        \dfrac{1}{16}(1-\xi^2)(1-\eta)^2 & \dfrac{1}{16}(1+\xi)^2(1-\eta)^2 & \dfrac{1}{16}(1-\xi^2)(1-\eta^2) & \dfrac{1}{16}(1+\xi)^2(1-\eta^2) \\
        \dfrac{1}{16}(1-\xi)^2(1-\eta^2) & \dfrac{1}{16}(1-\xi^2)(1-\eta^2) & \dfrac{1}{16}(1-\xi)^2(1+\eta)^2 & \dfrac{1}{16}(1-\xi^2)(1+\eta)^2 \\
        \dfrac{1}{16}(1-\xi^2)(1-\eta^2) & \dfrac{1}{16}(1+\xi)^2(1-\eta^2) & \dfrac{1}{16}(1-\xi^2)(1+\eta)^2 & \dfrac{1}{16}(1+\xi)^2(1+\eta)^2 \\
    \end{bmatrix}
\end{align*}

\begin{align*}
    N_i(-1, \eta)N_j(-1, \eta)
    =
    \begin{bmatrix}
        \dfrac{1}{4}(1-\eta)^2 & 0 & \dfrac{1}{4}(1-\eta^2) & 0 \\
        0 & 0 & 0 & 0 \\
        \dfrac{1}{4}(1-\eta^2) & 0 & \dfrac{1}{4}(1+\eta)^2 & 0 \\
        0 & 0 & 0 & 0 \\
    \end{bmatrix}
\end{align*}

\begin{align*}
    N_i(\xi, \eta)N_j(\xi, \eta)
    & =
    \begin{bmatrix}
        \dfrac{1}{4}(1-\xi)(1-\eta) & \dfrac{1}{4}(1+\xi)(1-\eta) & \dfrac{1}{4}(1-\xi)(1+\eta) & \dfrac{1}{4}(1+\xi)(1+\eta)
    \end{bmatrix}
    \begin{bmatrix}
        \dfrac{1}{4}(1-\xi)(1-\eta) \\
        \dfrac{1}{4}(1+\xi)(1-\eta) \\
        \dfrac{1}{4}(1-\xi)(1+\eta) \\
        \dfrac{1}{4}(1+\xi)(1+\eta)
    \end{bmatrix}\\
    & =
    \begin{bmatrix}
        \dfrac{1}{16}(1-\xi)^2(1-\eta)^2 + \dfrac{1}{16}(1+\xi)^2(1-\eta)^2 + \dfrac{1}{16}(1-\xi)^2(1+\eta)^2 + \dfrac{1}{16}(1+\xi)^2(1+\eta)^2
    \end{bmatrix}
\end{align*}

\begin{align*}
    N_i(-1, \eta)N_j(-1, \eta)
    =
    \begin{bmatrix}
        \dfrac{1}{4}(1-\eta)^2 + \dfrac{1}{4}(1+\eta)^2
    \end{bmatrix}
\end{align*}


Our problem is to calculate the equation:


The first element is a rectangular element, then by set $x = H1$ and $y = L_1$, we have
\begin{align*}
    \begin{bmatrix}
        \dfrac{1}{3} \left(\dfrac{x}{y} + \dfrac{y}{x}\right) & \dfrac{1}{6} \left(\dfrac{x}{y} - 2\dfrac{y}{x}\right) & -\dfrac{1}{6} \left(\dfrac{x}{y} + \dfrac{y}{x}\right) & \dfrac{1}{6} \left(\dfrac{y}{x} - 2\dfrac{x}{y}\right) \\
        \dfrac{1}{6} \left(\dfrac{x}{y} - 2\dfrac{y}{x}\right)  & \dfrac{1}{3} \left(\dfrac{x}{y} + \dfrac{y}{x}\right) & \dfrac{1}{6} \left(\dfrac{y}{x} - 2\dfrac{x}{y}\right) & -\dfrac{1}{6} \left(\dfrac{x}{y} + \dfrac{y}{x}\right) \\
        -\dfrac{1}{6} \left(\dfrac{x}{y} + \dfrac{y}{x}\right) & \dfrac{1}{6} \left(\dfrac{y}{x} - 2\dfrac{x}{y}\right) & \dfrac{1}{3} \left(\dfrac{x}{y} + \dfrac{y}{x}\right) & \dfrac{1}{6} \left(\dfrac{x}{y} - 2\dfrac{y}{x}\right)  \\
        \dfrac{1}{6} \left(\dfrac{y}{x} - 2\dfrac{x}{y}\right) & -\dfrac{1}{6} \left(\dfrac{x}{y} + \dfrac{y}{x}\right) & \dfrac{1}{6} \left(\dfrac{x}{y} - 2\dfrac{y}{x}\right) & \dfrac{1}{3} \left(\dfrac{x}{y} + \dfrac{y}{x}\right) \\
    \end{bmatrix}
\end{align*}
Then, by definition $y/x = \zeta$, we have:
\begin{align*}
    \begin{bmatrix}
        \dfrac{1}{3} \left(\dfrac{1}{\zeta} + \zeta\right) & \dfrac{1}{6} \left(\dfrac{1}{\zeta} - 2\zeta\right) & -\dfrac{1}{6} \left(\dfrac{1}{\zeta} + \zeta\right) & \dfrac{1}{6} \left(\zeta - 2\dfrac{1}{\zeta}\right) \\
        \dfrac{1}{6} \left(\dfrac{1}{\zeta} - 2\zeta\right)  & \dfrac{1}{3} \left(\dfrac{1}{\zeta} + \zeta\right) & \dfrac{1}{6} \left(\zeta - 2\dfrac{1}{\zeta}\right) & -\dfrac{1}{6} \left(\dfrac{1}{\zeta} + \zeta\right) \\
        -\dfrac{1}{6} \left(\dfrac{1}{\zeta} + \zeta\right) & \dfrac{1}{6} \left(\zeta - 2\dfrac{1}{\zeta}\right) & \dfrac{1}{3} \left(\dfrac{1}{\zeta} + \zeta\right) & \dfrac{1}{6} \left(\dfrac{1}{\zeta} - 2\zeta\right)  \\
        \dfrac{1}{6} \left(\zeta - 2\dfrac{1}{\zeta}\right) & -\dfrac{1}{6} \left(\dfrac{1}{\zeta} + \zeta\right) & \dfrac{1}{6} \left(\dfrac{1}{\zeta} - 2\zeta\right) & \dfrac{1}{3} \left(\dfrac{1}{\zeta} + \zeta\right)
    \end{bmatrix}
    =
    \begin{bmatrix}
        K_{00}^1 & K_{01}^1 & K_{02}^1 & K_{03}^1 \\
        K_{10}^1 & K_{11}^1 & K_{12}^1 & K_{13}^1 \\
        K_{20}^1 & K_{21}^1 & K_{22}^1 & K_{23}^1 \\
        K_{30}^1 & K_{31}^1 & K_{32}^1 & K_{33}^1
    \end{bmatrix}
\end{align*}

For the oblique domain:




\end{document}